{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Admin - Dashboard{% endblock %}
{% block heading %}Dashboard{% endblock %}

{% block content %}
<div class="flex flex-col h-full bg-base-100 ">
  <!-- Header -->
  <div class="grid grid-cols-1">
    <!-- Top Row with Selectors -->
    <div class="flex justify-between items-center p-4 border-b">
      <!-- Select Powerplant Dropdown -->
      <div class="dropdown dropdown-end">
      <div tabindex="0" role="button" class="btn btn-outline">Select Powerplants</div>
      <div tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-200 rounded-box w-52">
          {% if powerplants %}
              {% for powerplant in powerplants %}
              <div class="form-control">
                  <label class="label cursor-pointer">
                      <span class="label-text">{{ powerplant.name }}</span>
                      <input type="checkbox" class="checkbox powerplant-checkbox" value="{{ powerplant.id }}" checked />
                  </label>
              </div>
              {% endfor %}
          {% else %}
              <div class="form-control">
                  <p class="text-sm text-gray-500 p-2">No powerplants available</p>
              </div>
          {% endif %}
          <div class="divider my-1"></div>
          <button class="btn btn-primary btn-sm" onclick="updatePowerplantChart()">Apply</button>
      </div>
      </div>
      
      <!-- Date Range Picker -->
      <div class="dropdown dropdown-end">
        <div tabindex="0" role="button" class="btn btn-outline flex items-center gap-2">
          <span class="text-orange-500">Range</span>
          <span id="dateRangeText">: Apr 25, 2018 12:00 AM - Apr 26, 2018 12:00 AM</span>
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-200 rounded-box w-96">
          <div class="p-2">
            
            <div class="grid grid-cols-2 gap-2">
              <div>
                <label class="label">Start Date</label>
                <input type="date" id="startDate" class="input input-bordered w-full" />
              </div>
              <div>
                <label class="label">End Date</label>
                <input type="date" id="endDate" class="input input-bordered w-full" />
              </div>
              <div>
                <label class="label">Start Time</label>
                <input type="time" id="startTime" class="input input-bordered w-full" value="00:00" />
              </div>
              <div>
                <label class="label">End Time</label>
                <input type="time" id="endTime" class="input input-bordered w-full" value="23:59" />
              </div>
            </div>
            <button class="btn btn-primary w-full mt-2" onclick="applyCustomDateRange()">Apply</button>
          </div>
        </div>
      </div>
    </div>

    

  <!-- Main Content -->
  <div class="flex-1 p-4">
    <!-- Summary Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

      <!-- Total Power Card -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-4">
          <div class="flex justify-between">
            <h2 class="card-title text-base">Total Power</h2>
          </div>
          <p class="text-4xl font-bold mt-2">
            {% if total_power %}
              {{ total_power|floatformat:0|intcomma }}W
            {% else %}
              0W
            {% endif %}
          </p>
          <div class="card-actions justify-end mt-2">
            <button class="btn btn-sm btn-ghost text-primary">View detail</button>
          </div>
        </div>
      </div>


      <!-- Total Panel Card -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-4">
          <div class="flex justify-between">
            <h2 class="card-title text-base">Total Panel</h2>
          </div>
          <p class="text-4xl font-bold mt-2">0</p>
          <div class="card-actions justify-end mt-2">
            <button class="btn btn-sm btn-ghost text-primary">View detail</button>
          </div>
        </div>
      </div>

      <!-- Total Reports Card -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-4">
          <div class="flex justify-between">
            <h2 class="card-title text-base">Total Reports</h2>
          </div>
          <p class="text-4xl font-bold mt-2">0</p>
          <div class="card-actions justify-end mt-2">
            <button class="btn btn-sm btn-ghost text-primary">View detail</button>
          </div>
        </div>
      </div>

      <!-- Total Unusable panel Card -->
    <div class="card bg-base-100 shadow-xl">
        <div class="card-body p-4">
          <div class="flex justify-between">
            <h2 class="card-title text-base">Total Unusable panel</h2>
          </div>
          <p class="text-4xl font-bold mt-2">0</p>
          <div class="card-actions justify-end mt-2">
            <button class="btn btn-sm btn-ghost text-primary">View detail</button>
          </div>
        </div>
      </div>

      
    </div>

    

    <!-- Powerplant Comparison Section -->
    <div class="card bg-base-100 shadow-xl mb-6">
      <div class="card-body">
        
          
        
        <!-- Powerplant Stats -->
        <div class="grid grid-cols-5 gap-4 mb-4">
          {% for powerplant in powerplants %}
          <div class="stat bg-base-200 rounded-box p-2">
              <div class="stat-title">{{ powerplant.name }}</div>
              <div class="stat-value text-xl font-medium">
                  {% if powerplant.current_power %}
                      {{ powerplant.current_power }}W
                  {% else %}
                      No data
                  {% endif %}
              </div>
              <div class="stat-desc {% if powerplant.power_change > 0 %}text-success{% elif powerplant.power_change < 0 %}text-error{% endif %}">
                  {% if powerplant.power_change %}
                      {% if powerplant.power_change > 0 %}+{% endif %}{{ powerplant.power_change }}%
                  {% endif %}
              </div>
          </div>
          {% empty %}
          <div class="stat bg-base-200 rounded-box p-2">
              <div class="stat-title">No powerplants</div>
              <div class="stat-value text-xl font-medium">No data</div>
          </div>
          {% endfor %}
        </div>


        
        <!-- Powerplant Chart -->
        <div class="w-full h-64">
          <canvas id="powerplantChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Hourly Power Report Section -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <div class="flex justify-between items-center mb-4">
          <h2 class="card-title">Hourly Power Report</h2>
          <button class="btn btn-ghost text-primary">View All</button>
        </div>
        
        <div class="flex flex-wrap gap-2 mb-4">
          <div class="form-control">
            <select class="select select-bordered w-full max-w-xs">
              <option disabled selected>Select Powerplant</option>
              {% if powerplants %}
                {% for powerplant in powerplants %}
                  <option value="{{ powerplant.id }}">{{ powerplant.name }}</option>
                {% endfor %}
              {% else %}
                <option disabled>No powerplants available</option>
              {% endif %}
            </select>
          </div>
          
          <div class="form-control">
            <select class="select select-bordered w-full max-w-xs" multiple>
              <option disabled>Select Zones</option>
              {% if zones %}
                {% for zone in zones %}
                  <option value="{{ zone.id }}">{{ zone.name }}</option>
                {% endfor %}
              {% else %}
                <option disabled>No zones available</option>
              {% endif %}
            </select>
          </div>

          <div class="form-control">
            <select class="select select-bordered w-full max-w-xs" multiple>
              <option disabled>Select Panels</option>
              {% if panels %}
                {% for panel in panels %}
                  <option value="{{ panel.id }}">{{ panel.name }}</option>
                {% endfor %}
              {% else %}
                <option disabled>No panels available</option>
              {% endif %}
            </select>
          </div>

        
        <!-- Hourly Chart -->
        <div class="w-full h-64">
          <canvas id="hourlyChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Include Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // Initialize charts when the DOM is loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Get powerplant data from Django template
    const powerplantData = [
      {% for powerplant in powerplants %}
      {
        id: {{ powerplant.id }},
        name: "{{ powerplant.name }}",
        // Add default data for the chart - you might want to replace this with actual data
        data: [280, 300, 320, 300, 290, 310, 300, 290, 300],
        borderColor: getRandomColor({{ forloop.counter0 }})
      },
      {% empty %}
      // Fallback data if no powerplants exist
      {
        id: 1,
        name: "No Powerplants",
        data: [0, 0, 0, 0, 0, 0, 0, 0, 0],
        borderColor: 'rgba(200, 200, 200, 1)'
      }
      {% endfor %}
    ];
    
    // Initialize powerplant comparison chart
    const powerplantCtx = document.getElementById('powerplantChart').getContext('2d');
    const powerplantChart = new Chart(powerplantCtx, {
      type: 'line',
      data: {
        labels: ['Mon, 20', 'Tue, 21', 'Wed, 22', 'Thu, 23', 'Fri, 24', 'Sat, 25', 'Sun, 26', 'Mon, 27', 'Tue, 28'],
        datasets: powerplantData.map(plant => ({
          label: plant.name,
          data: plant.data,
          borderColor: plant.borderColor,
          tension: 0.3,
          powerplantId: plant.id // Store the ID for filtering
        }))
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false,
            min: 100,
            max: 500
          }
        },
        plugins: {
          tooltip: {
            mode: 'index',
            intersect: false
          }
        }
      }
    });
    
    // Store chart instance for later updates
    window.powerplantChart = powerplantChart;
    
    // Initialize hourly power report chart
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    const hourlyChart = new Chart(hourlyCtx, {
      type: 'bar',
      data: {
        labels: ['1-2AM', '2-3AM', '3-4AM', '4-5AM', '5-6AM', '6-7AM', '7-8AM', '8-9AM', '9-10AM', '10-11AM', '11-12PM'],
        datasets: [{
          label: 'Power (W)',
          data: [1500, 1800, 2200, 2500, 1800, 2000, 2400, 2800, 1700, 2100, 2431],
          backgroundColor: 'rgba(54, 162, 235, 0.5)',
          borderColor: 'rgba(54, 162, 235, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 5000
          }
        }
      }
    });
    
    // Set up tab functionality
    const tabs = document.querySelectorAll('.tabs .tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('tab-active'));
        tab.classList.add('tab-active');
      });
    });
    
    // Initialize date pickers with today's date
    const today = new Date();
    const formattedDate = today.toISOString().split('T')[0];
    document.getElementById('startDate').value = formattedDate;
    document.getElementById('endDate').value = formattedDate;
  });
  
  // Function to generate consistent colors for powerplants
  function getRandomColor(index) {
    const colors = [
      'rgba(75, 192, 192, 1)',
      'rgba(255, 99, 132, 1)',
      'rgba(255, 205, 86, 1)',
      'rgba(54, 162, 235, 1)',
      'rgba(153, 102, 255, 1)',
      'rgba(255, 159, 64, 1)',
      'rgba(201, 203, 207, 1)'
    ];
    return colors[index % colors.length];
  }
  
  // Date range functions
  function applyCustomDateRange() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    const startTime = document.getElementById('startTime').value;
    const endTime = document.getElementById('endTime').value;
    
    if (startDate && endDate) {
      // Combine date and time
      const start = new Date(`${startDate}T${startTime}`);
      const end = new Date(`${endDate}T${endTime}`);
      
      if (start > end) {
        alert('Start date/time cannot be after end date/time');
        return;
      }
      
      // Format the display text
      const formattedRange = formatDateRange(start, end);
      updateDateRangeDisplay(formattedRange);
      
      // Here you would update your charts with the new date range
      // updateCharts(start, end);
    }
  }

  function formatDateRange(start, end) {
    // Format dates with time
    const formatDateTime = (date) => {
      return date.toLocaleString('en-US', { 
        month: 'short', 
        day: 'numeric', 
        year: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        hour12: true
      });
    };
    
    return `${formatDateTime(start)} - ${formatDateTime(end)}`;
  }

  function updateDateRangeDisplay(dateRangeText) {
    document.getElementById('dateRangeText').textContent = `: ${dateRangeText}`;
  }

  // Initialize with default date range
  window.addEventListener('DOMContentLoaded', () => {
    // Set default dates (current day and next day)
    const today = new Date();
    const tomorrow = new Date();
    tomorrow.setDate(today.getDate() + 1);
    
    // Format dates for input fields
    const formatDateForInput = (date) => {
      return date.toISOString().split('T')[0];
    };
    
    // Set default values for date inputs
    document.getElementById('startDate').value = formatDateForInput(today);
    document.getElementById('endDate').value = formatDateForInput(tomorrow);
    
    // Set default times
    document.getElementById('startTime').value = "00:00";
    document.getElementById('endTime').value = "00:00";
    
    // Apply the default range
    applyCustomDateRange();
  });


  
  // Updated function to work with dynamic powerplant data
  function updatePowerplantChart() {
    const checkboxes = document.querySelectorAll('.powerplant-checkbox');
    const selectedPowerplants = [];
    
    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        selectedPowerplants.push(parseInt(checkbox.value));
      }
    });
    
    // Filter datasets based on selected powerplants
    if (window.powerplantChart) {
      window.powerplantChart.data.datasets.forEach(dataset => {
        const powerplantId = dataset.powerplantId;
        dataset.hidden = !selectedPowerplants.includes(powerplantId);
      });
      
      window.powerplantChart.update();
    }
  }
</script>
{% endblock %}
